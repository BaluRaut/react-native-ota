<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTA POC Documentation</title>
    <!-- PrismJS for Monaco-like Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h2 { color: #2980b9; margin-top: 30px; }
        h3 { color: #16a085; }

        /* Code Block Styling (Monaco-like) */
        pre[class*="language-"] {
            border-radius: 8px;
            margin: 1.5em 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto; /* Fix for overflowing code */
            white-space: pre; /* Force no wrapping */
        }
        code[class*="language-"] {
            font-family: 'Consolas', 'Monaco', 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 14px;
            text-shadow: none;
        }
        /* Ensure code inside pre is transparent so it takes pre's background */
        pre[class*="language-"] > code {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
        }
        /* Inline code - Only target code tags that do NOT have a language class */
        code:not([class*="language-"]) {
            background-color: #e8e8e8;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            color: #c7254e;
        }        .container {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .problem-box {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
        }
        .solution-box {
            background-color: #d4edda;
            border-left: 5px solid #28a745;
            padding: 15px;
            margin-top: 10px;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }
        .success { background-color: #27ae60; }

        /* Comparison Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95em;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #2c3e50;
            color: #ffffff;
            font-weight: bold;
        }
        tr:hover { background-color: #f5f5f5; }
        tr:nth-of-type(even) { background-color: #f8f9fa; }
        .check-icon { color: #27ae60; font-weight: bold; }
        .cross-icon { color: #c0392b; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Self-Hosted OTA Update System <span class="status-badge success">POC SUCCESS</span></h1>

    <h2>1. Overview</h2>
    <p>This project demonstrates a secure, self-hosted Over-The-Air (OTA) update system for React Native applications using the <code>hot-updater</code> library. The goal was to bypass third-party services (like CodePush) and maintain full control over the update distribution pipeline using a custom backend.</p>

    <h2>2. Architecture</h2>
    <p>The system consists of three main components running locally to simulate a production environment:</p>

    <h3>A. The Client (React Native App)</h3>
    <ul>
        <li><strong>Framework:</strong> React Native 0.82.0</li>
        <li><strong>Library:</strong> <code>@hot-updater/react-native</code> (v0.23.1)</li>
        <li><strong>Role:</strong> Checks for updates, downloads bundles, and reloads the JS context.</li>
    </ul>

    <h3>B. The API Server (Port 3000)</h3>
    <ul>
        <li><strong>Role:</strong> Acts as the "Gatekeeper".</li>
        <li><strong>Function:</strong> Validates the user (Mock Auth), generates a <strong>Signed URL</strong>, and returns update metadata.</li>
    </ul>

    <h3>C. The CDN Server (Port 4000)</h3>
    <ul>
        <li><strong>Role:</strong> Acts as the "Storage".</li>
        <li><strong>Function:</strong> Hosts the <code>update.zip</code> and blocks access unless a valid <code>?token=secure-signature</code> is present.</li>
    </ul>

    <hr>

    <h2>4. The Update Process Workflow</h2>
    
    <h3>A. Developer Side (Releasing an Update)</h3>
    <p>You can deploy updates either <strong>Manually</strong> or <strong>Automatically</strong>.</p>

    <h4>Option 1: Automatic Deployment (Recommended)</h4>
    <p>We have created a script <code>deploy.js</code> in the project root that handles bundling, zipping, hashing, and updating metadata in one go.</p>
    <ol>
        <li><strong>Run the script:</strong>
            <pre>node deploy.js 2.0.1</pre>
        </li>
        <li><strong>Done!</strong> The script will:
            <ul>
                <li>Build the React Native bundle.</li>
                <li>Zip it.</li>
                <li>Calculate the SHA256 hash.</li>
                <li>Copy it to the CDN folder.</li>
                <li>Update <code>metadata.json</code> automatically.</li>
            </ul>
        </li>
    </ol>

    <h4>Option 2: Manual Deployment</h4>
    <ol>
        <li><strong>Modify Code:</strong> Make changes to your React Native JavaScript/TypeScript code.</li>
        <li><strong>Generate Bundle:</strong> Run the React Native bundler to compile the JS.
            <pre>npx react-native bundle --platform android --dev false --entry-file index.js --bundle-output dist/index.android.bundle</pre>
        </li>
        <li><strong>Package Update:</strong> Zip the bundle file.
            <pre>Compress-Archive -Path dist/index.android.bundle -DestinationPath dist/update.zip -Force</pre>
        </li>
        <li><strong>Calculate Hash:</strong> You need the SHA256 hash for security.
            <pre>Get-FileHash dist/update.zip -Algorithm SHA256</pre>
        </li>
        <li><strong>Deploy Files:</strong>
            <ul>
                <li>Move <code>dist/update.zip</code> to <code>local-system/cdn-server/storage/android/</code>.</li>
            </ul>
        </li>
        <li><strong>Update Metadata:</strong>
            <ul>
                <li>Open <code>local-system/cdn-server/storage/android/metadata.json</code>.</li>
                <li>Update <code>"version"</code>, <code>"fileHash"</code>, and <code>"id"</code>.</li>
            </ul>
        </li>
    </ol>

    <h3>B. User Side (Receiving an Update)</h3>
        <li><strong>Generate Bundle:</strong> Run the React Native bundler to compile the JS.
            <pre>npx react-native bundle --platform android --dev false --entry-file index.js --bundle-output dist/index.android.bundle</pre>
        </li>
        <li><strong>Package Update:</strong> Zip the bundle file.
            <pre>Compress-Archive -Path dist/index.android.bundle -DestinationPath dist/update.zip</pre>
        </li>
        <li><strong>Deploy:</strong>
            <ul>
                <li>Upload <code>update.zip</code> to the CDN storage folder.</li>
                <li>Update <code>metadata.json</code> with the new version number, file hash, and download URL.</li>
            </ul>
        </li>
    </ol>

    <h3>B. User Side (Receiving an Update)</h3>
    <ol>
        <li><strong>Check:</strong> The App sends a request to <code>GET /check</code>.</li>
        <li><strong>Authenticate:</strong> The API Server validates the user's session/token.</li>
        <li><strong>Sign:</strong> The API Server generates a temporary "Signed URL".</li>
        <li><strong>Download:</strong> The App uses this secure URL to download the zip from the CDN.</li>
        <li><strong>Apply:</strong> The library unzips the bundle and replaces the current JS bundle.</li>
        <li><strong>Reload:</strong> The App reloads, instantly showing the new version.</li>
    </ol>

    <hr>

    <h2>5. Challenges & Solutions (Troubleshooting Log)</h2>
    <p>During the implementation, we encountered several critical issues. Here is how we solved them:</p>

    <!-- Issue 1 -->
    <div class="problem-box">
        <strong>Issue 1: "Property '__HOT_UPDATER_BUNDLE_ID' doesn't exist"</strong><br>
        The app crashed immediately on launch because the bundle ID was missing.
    </div>
    <div class="solution-box">
        <strong>Solution:</strong><br>
        We installed <code>hot-updater</code> as a dev dependency and added <code>'hot-updater/babel-plugin'</code> to <code>babel.config.js</code>. This injects the necessary ID during the build process.
    </div>

    <!-- Issue 2 -->
    <div class="problem-box">
        <strong>Issue 2: "undefined is not a function" (API Mismatch)</strong><br>
        Calling <code>HotUpdater.check()</code> caused a crash. The documentation we followed was outdated.
    </div>
    <div class="solution-box">
        <strong>Solution:</strong><br>
        We inspected the source code in <code>node_modules</code> and found the API had changed in v0.23. We switched to <code>HotUpdater.checkForUpdate()</code> and <code>update.updateBundle()</code>.
    </div>

    <!-- Issue 3 -->
    <div class="problem-box">
        <strong>Issue 3: Server 404 / 403 Errors</strong><br>
        The app could not communicate with the local API server due to method and response format mismatches.
    </div>
    <div class="solution-box">
        <strong>Solution:</strong><br>
        We updated <code>api.js</code> to handle <code>GET</code> requests (instead of POST) and ensured the JSON response included <code>fileUrl</code> instead of just <code>url</code>.
    </div>

    <!-- Issue 4 -->
    <div class="problem-box">
        <strong>Issue 4: Network Security Policy</strong><br>
        Android blocked the connection to <code>http://10.0.2.2:3000</code> because it was not HTTPS.
    </div>
    <div class="solution-box">
        <strong>Solution:</strong><br>
        We modified <code>AndroidManifest.xml</code> to add <code>android:usesCleartextTraffic="true"</code> to allow local HTTP testing.
    </div>

    <!-- Issue 5 -->
    <div class="problem-box">
        <strong>Issue 5: "No update available" (Testing Logic)</strong><br>
        We initially built the app with "Version 2.0.0", so it didn't see the update on the server (which was also 2.0.0).
    </div>
    <div class="solution-box">
        <strong>Solution:</strong><br>
        We reverted the App code to "Version 1.0.0", rebuilt the APK, and then the update to "Version 2.0.0" was successfully detected and applied.
    </div>

    <hr>

    <h2>6. Final Result</h2>
    <ul>
        <li><strong>Initial State:</strong> App running <strong>Version 1.0.0</strong>.</li>
        <li><strong>Action:</strong> User clicked "Check for Secure Update".</li>
        <li><strong>Process:</strong> App authenticated -> Received Signed URL -> Downloaded Zip -> Reloaded.</li>
        <li><strong>Final State:</strong> App running <strong>Version 2.0.0</strong> without an App Store release.</li>
    </ul>

    <hr>

    <h2>7. Source Code Reference</h2>

    <h3>A. CDN Server (cdn.js)</h3>
    <p>This server simulates CloudFront/S3. It hosts the files but blocks access unless a valid token is present.</p>
    <pre><code class="language-javascript">const express = require('express');
const cors = require('cors');
const path = require('path');
const app = express();

app.use(cors());

// MIDDLEWARE: Simulate "Signed URL" Security
// Only allow downloads if ?token=secure-signature is present
const secureGuard = (req, res, next) => {
    const token = req.query.token;
    if (token !== 'secure-signature') {
        console.log(`üõë Blocked access to ${req.path} (Missing/Invalid Token)`);
        return res.status(403).send('Forbidden: Invalid Signature');
    }
    console.log(`‚úÖ Serving ${req.path}`);
    next();
};

// Serve static files from 'storage' folder, PROTECTED by guard
app.use('/files', secureGuard, express.static(path.join(__dirname, 'storage')));

app.listen(4000, () => {
    console.log('‚òÅÔ∏è  Fake CloudFront running on http://localhost:4000');
    console.log('üìÇ Serving files from ./storage');
});</code></pre>

    <h3>B. API Server (api.js)</h3>
    <p>This server simulates your backend API. It authenticates the user and generates the signed URL.</p>
    <pre><code class="language-javascript">const express = require('express');
const cors = require('cors');
const fs = require('fs');
const path = require('path');
const app = express();

app.use(cors());
app.use(express.json());

// Point to the CDN storage to read metadata
const STORAGE_PATH = path.join(__dirname, '../cdn-server/storage');

app.get('/check', (req, res) => {
    console.log("üîé App requested update check...");

    // 1. Auth Check (Mock)
    if (req.headers.authorization !== 'Bearer my-secret-user') {
        return res.status(401).json({ error: "Unauthorized" });
    }

    // Client sends platform in headers: x-app-platform
    const platform = req.headers['x-app-platform'] || 'android';
    const metadataPath = path.join(STORAGE_PATH, platform, 'metadata.json');

    if (!fs.existsSync(metadataPath)) {
        console.log(`‚ö†Ô∏è Metadata not found at ${metadataPath}`);
        return res.json({ update: false });
    }

    // 2. Read Metadata
    try {
        const metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf8'));

        // 3. "Sign" the URL
        // We append the token that the CDN expects
        const signedUrl = `${metadata.fileUrl}?token=secure-signature`;

        console.log("‚úçÔ∏è  Signed URL generated");

        // 4. Return to App
        res.json({
            ...metadata,
            fileUrl: signedUrl
        });
    } catch (err) {
        console.error("Error reading metadata:", err);
        res.status(500).json({ error: "Internal Server Error" });
    }
});

app.listen(3000, () => console.log('üõ°Ô∏è  Auth API running on http://localhost:3000'));</code></pre>

    <h3>C. React Native Client (App.tsx)</h3>
    <p>The client-side logic to check for updates and apply them.</p>
    <pre><code class="language-tsx">import React, { useState } from 'react';
import { View, Text, Button, Alert, StyleSheet, ActivityIndicator } from 'react-native';
import { HotUpdater } from '@hot-updater/react-native';

const App = () => {
  const [status, setStatus] = useState('Idle');
  const [loading, setLoading] = useState(false);

  // CHANGE THIS TEXT TO TEST UPDATE (e.g., "Version 2.0.0")
  const CURRENT_VERSION_TEXT = "Version 1.0.0";

  const checkUpdate = async () => {
    setLoading(true);
    setStatus('Checking API...');

    try {
      // 1. Check for update
      const update = await HotUpdater.checkForUpdate({
        source: "http://10.0.2.2:3000/check",
        requestHeaders: {
          Authorization: "Bearer my-secret-user"
        }
      });

      if (update) {
        setStatus(`Found update! Downloading...`);

        // 2. Download and Apply Bundle
        await update.updateBundle();

        Alert.alert("Update Ready", "The app will now restart to apply the update.", [
            { text: "OK", onPress: () => HotUpdater.reload() }
        ]);
        setStatus('Update applied. Restarting...');
      } else {
        setStatus('No update available on server.');
      }
    } catch (e: any) {
      setStatus('Error: ' + e.message);
      console.error(e);
    } finally {
      setLoading(false);
    }
  };

  return (
    <View style={styles.container}>
      <Text style={styles.title}>OTA POC App</Text>
      <View style={styles.card}>
        <Text style={styles.label}>Current Bundle Version:</Text>
        <Text style={styles.version}>{CURRENT_VERSION_TEXT}</Text>
      </View>
      <View style={styles.statusBox}>
        <Text style={styles.statusText}>{status}</Text>
      </View>
      {loading ? (
        <ActivityIndicator size="large" color="#0000ff" />
      ) : (
        <Button title="Check for Secure Update" onPress={checkUpdate} />
      )}
    </View>
  );
};

const styles = StyleSheet.create({
  container: { 
    flex: 1, 
    justifyContent: 'center', 
    padding: 20, 
    backgroundColor: '#f5f5f5' 
  },
  title: { 
    fontSize: 24, 
    fontWeight: 'bold', 
    marginBottom: 30, 
    textAlign: 'center' 
  },
  card: { 
    backgroundColor: 'white', 
    padding: 20, 
    borderRadius: 10, 
    marginBottom: 20, 
    elevation: 2 
  },
  label: { 
    fontSize: 14, 
    color: '#666' 
  },
  version: { 
    fontSize: 28, 
    fontWeight: 'bold', 
    color: '#2563eb', 
    marginTop: 5 
  },
  statusBox: { 
    backgroundColor: '#e0e7ff', 
    padding: 15, 
    borderRadius: 8, 
    marginBottom: 20 
  },
  statusText: { 
    color: '#1e40af', 
    textAlign: 'center' 
  }
});

export default App;</code></pre>

    <hr>

    <h2>8. Comparison: Self-Hosted vs. Managed OTA</h2>
    <p>Why choose a self-hosted solution over managed services like CodePush or Expo Updates? Here is a detailed comparison.</p>

    <table>
        <thead>
            <tr>
                <th>Feature</th>
                <th>Self-Hosted (Our Solution)</th>
                <th>Managed (CodePush/Expo)</th>
                <th>RevoPush</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Cost</strong></td>
                <td><span class="check-icon">‚úî</span> Free (Only Infrastructure Costs)</td>
                <td><span class="cross-icon">‚úò</span> Paid Tiers / Expensive at Scale</td>
                <td><span class="cross-icon">‚úò</span> Free Tier (Limited) / Paid ($15+)</td>
            </tr>
            <tr>
                <td><strong>Data Privacy</strong></td>
                <td><span class="check-icon">‚úî</span> 100% Private (Your Servers)</td>
                <td><span class="cross-icon">‚úò</span> Shared with 3rd Party</td>
                <td><span class="cross-icon">‚úò</span> Shared with Provider</td>
            </tr>
            <tr>
                <td><strong>Server Control</strong></td>
                <td><span class="check-icon">‚úî</span> Full Access (Logs, Config)</td>
                <td><span class="cross-icon">‚úò</span> Black Box</td>
                <td><span class="cross-icon">‚úò</span> Limited Control</td>
            </tr>
            <tr>
                <td><strong>Custom Auth</strong></td>
                <td><span class="check-icon">‚úî</span> Unlimited (JWT, OAuth, VPN)</td>
                <td><span class="cross-icon">‚úò</span> Limited / Standard Flows</td>
                <td><span class="cross-icon">‚úò</span> Standard Auth</td>
            </tr>
            <tr>
                <td><strong>Bundle Size</strong></td>
                <td><span class="check-icon">‚úî</span> Unlimited</td>
                <td><span class="cross-icon">‚úò</span> Often Capped (e.g., 50MB)</td>
                <td><span class="cross-icon">‚úò</span> Capped / Tiered</td>
            </tr>
            <tr>
                <td><strong>Rate Limits</strong></td>
                <td><span class="check-icon">‚úî</span> None (Scale as needed)</td>
                <td><span class="cross-icon">‚úò</span> API Rate Limits apply</td>
                <td><span class="cross-icon">‚úò</span> Yes (50 releases/mo limit on Free)</td>
            </tr>
            <tr>
                <td><strong>Security</strong></td>
                <td><span class="check-icon">‚úî</span> Custom (Signed URLs, IP Allowlist)</td>
                <td><span class="cross-icon">‚úò</span> Standard Shared Keys</td>
                <td><span class="cross-icon">‚úò</span> Standard Keys</td>
            </tr>
            <tr>
                <td><strong>Uptime SLA</strong></td>
                <td><span class="cross-icon">‚úò</span> Your Responsibility</td>
                <td><span class="check-icon">‚úî</span> Provider's Responsibility</td>
                <td><span class="check-icon">‚úî</span> Provider's Responsibility</td>
            </tr>
            <tr>
                <td><strong>Setup Complexity</strong></td>
                <td><span class="cross-icon">‚úò</span> High (DIY Infrastructure)</td>
                <td><span class="check-icon">‚úî</span> Low (Plug & Play)</td>
                <td><span class="check-icon">‚úî</span> Low (Easy Setup)</td>
            </tr>
            <tr>
                <td><strong>Maintenance</strong></td>
                <td><span class="cross-icon">‚úò</span> You patch servers</td>
                <td><span class="check-icon">‚úî</span> Managed by Provider</td>
                <td><span class="check-icon">‚úî</span> Managed by Provider</td>
            </tr>
            <tr>
                <td><strong>China Access</strong></td>
                <td><span class="check-icon">‚úî</span> Full Control (Choose your CDN)</td>
                <td><span class="cross-icon">‚úò</span> Often Blocked or Slow</td>
                <td><span class="cross-icon">‚úò</span> Depends on CDN</td>
            </tr>
            <tr>
                <td><strong>Integration</strong></td>
                <td><span class="check-icon">‚úî</span> Connect to any Backend/DB</td>
                <td><span class="cross-icon">‚úò</span> Provider SDK only</td>
                <td><span class="cross-icon">‚úò</span> SDK Dependent</td>
            </tr>
            <tr>
                <td><strong>Rollback Speed</strong></td>
                <td><span class="check-icon">‚úî</span> Instant (Metadata change)</td>
                <td><span class="check-icon">‚úî</span> Dashboard/CLI delay</td>
                <td><span class="check-icon">‚úî</span> Dashboard Control</td>
            </tr>
            <tr>
                <td><strong>Analytics</strong></td>
                <td><span class="check-icon">‚úî</span> Custom (Your DB/Tools)</td>
                <td><span class="check-icon">‚úî</span> Provider Dashboard</td>
                <td><span class="check-icon">‚úî</span> Built-in Analytics</td>
            </tr>
            <tr>
                <td><strong>Vendor Lock-in</strong></td>
                <td><span class="check-icon">‚úî</span> None</td>
                <td><span class="cross-icon">‚úò</span> High</td>
                <td><span class="cross-icon">‚úò</span> High</td>
            </tr>
        </tbody>
    </table>

</div>

<!-- PrismJS Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>

</body>
</html>